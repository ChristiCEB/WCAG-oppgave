<%- include('partials/header', { title: site.title }) %>
  <nav class="breadcrumb">
    <a href="/">Nettsteder</a>
    <span aria-hidden="true"> / </span>
    <span><%= site.title %></span>
  </nav>

  <article class="site-detail">
    <h1><%= site.title %></h1>
    <img src="<%= site.imagePath %>" alt="Forsidebilde for <%= site.title %>" class="site-detail-image" width="400" height="250">
    <p>
      <a href="<%= site.url %>" target="_blank" rel="noopener noreferrer" class="btn btn-primary">Ã…pne nettstedet</a>
    </p>
    <p class="meta">Registrert: <%= new Date(site.createdAt).toLocaleDateString('nb-NO') %></p>
  </article>

  <section class="reviews-section" aria-labelledby="vurderinger-heading">
    <h2 id="vurderinger-heading">Vurderinger</h2>

    <% if (typeof reported !== 'undefined' && reported) { %>
      <p class="report-bekreftelse" role="status">Rapporten er mottatt. Takk for at du hjelper til.</p>
    <% } %>

    <% if (typeof averageScore === 'string' && averageScore) { %>
      <p class="average-score">Gjennomsnittscore: <strong><%= averageScore %></strong> av 5</p>
    <% } %>

    <% if (typeof user !== 'undefined' && user) { %>
      <h3>Skriv en vurdering</h3>
      <%- include('partials/errors') %>
      <form method="post" action="/sites/<%= site._id %>/reviews" class="review-form">
        <label for="wcagScore">Vurdering (1â€“5)</label>
        <select id="wcagScore" name="wcagScore" required>
          <% for (let i = 1; i <= 5; i++) { %>
            <option value="<%= i %>" <%= (typeof formData !== 'undefined' && formData && Number(formData.wcagScore) === i) ? 'selected' : (typeof formData === 'undefined' && i === 3) ? 'selected' : '' %>><%= i %></option>
          <% } %>
        </select>

        <label for="summary">Kort oppsummering</label>
        <input type="text" id="summary" name="summary" required maxlength="200"
               value="<%= typeof formData !== 'undefined' && formData && formData.summary ? formData.summary.replace(/"/g, '&quot;') : '' %>">

        <label for="details">Detaljer (valgfritt)</label>
        <textarea id="details" name="details" rows="4"><%= typeof formData !== 'undefined' && formData && formData.details ? formData.details : '' %></textarea>

        <button type="submit" class="btn btn-primary">Send vurdering</button>
      </form>
    <% } else { %>
      <p class="login-prompt"><a href="/login">Logg inn</a> for Ã¥ vurdere dette nettstedet.</p>
    <% } %>

    <h3>Alle vurderinger</h3>
    <p class="sort-links">Sorter: 
      <% const currentReviewSort = (typeof reviewSort !== 'undefined' && reviewSort) ? reviewSort : 'nyttighet'; %>
      <% if (currentReviewSort === 'nyttighet') { %>
        <strong>Nyttighet</strong> Â· <a href="/sites/<%= site._id %>?sort=nyeste">Nyeste</a>
      <% } else { %>
        <a href="/sites/<%= site._id %>?sort=nyttighet">Nyttighet</a> Â· <strong>Nyeste</strong>
      <% } %>
    </p>
    <% const reviewList = typeof reviews !== 'undefined' && reviews ? reviews : []; %>
    <% if (reviewList.length > 0) { %>
      <ul class="review-list">
        <% const voteDataMap = typeof voteData !== 'undefined' && voteData ? voteData : {}; %>
        <% reviewList.forEach(function(review) { %>
          <% const rId = review._id.toString(); const vd = voteDataMap[rId] || { sum: 0, userVote: null }; const isOwn = typeof user !== 'undefined' && user && review.user && (review.user._id ? String(review.user._id) : String(review.user)) === String(user.id); %>
          <li class="review-item">
            <p class="review-meta">
              <strong><%= review.user ? review.user.username : 'Ukjent' %></strong>
              Â· <%= new Date(review.createdAt).toLocaleDateString('nb-NO') %>
              Â· Score: <%= review.wcagScore %>/5
            </p>
            <p class="review-summary"><%= review.summary %></p>
            <% if (review.details) { %>
              <p class="review-details"><%= review.details %></p>
            <% } %>
            <div class="review-votes" aria-label="Nyttighet av vurderingen">
              <span class="vote-sum">Nyttighet: <strong><%= vd.sum >= 0 ? '+' : '' %><%= vd.sum %></strong></span>
              <% if (isOwn) { %>
                <span class="own-review-msg">Du kan ikke stemme pÃ¥ egen vurdering.</span>
              <% } else if (typeof user !== 'undefined' && user) { %>
                <form method="post" action="/reviews/<%= review._id %>/vote" class="vote-form vote-form-up">
                  <input type="hidden" name="vote" value="1">
                  <button type="submit" class="vote-btn <%= vd.userVote === 1 ? 'vote-active' : '' %>" title="Stem positivt" aria-label="Stem positivt">ğŸ‘</button>
                </form>
                <form method="post" action="/reviews/<%= review._id %>/vote" class="vote-form vote-form-down">
                  <input type="hidden" name="vote" value="-1">
                  <button type="submit" class="vote-btn <%= vd.userVote === -1 ? 'vote-active' : '' %>" title="Stem negativt" aria-label="Stem negativt">ğŸ‘</button>
                </form>
              <% } %>
              <a href="/reviews/<%= review._id %>/report" class="btn-report">RapportÃ©r</a>
            </div>
          </li>
        <% }); %>
      </ul>
    <% } else { %>
      <p>Ingen vurderinger ennÃ¥.</p>
    <% } %>
  </section>
<%- include('partials/footer') %>
